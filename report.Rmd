---
title: "Mountain Climbers"
---

```{r, include=FALSE}
library(knitr)
opts_chunk$set(echo=FALSE, message=FALSE)

library(tidyverse)
library(magrittr)
library(crotchet)
read_graphviz_chunk("team-structures", "evoteams")
```

```{r helper-functions, include=FALSE}
get_experiment_data <- function(experiment) {
  file.path("experiments", paste0(experiment, ".csv")) %>%
    read_csv() %>%
    recode_fitness_as_pct()
}

recode_fitness_as_pct <- function(frame) {
  mutate(frame, fitness_pct = 1 - fitness/min(fitness))
}

extract_position <- function(frame) {
  pos <- map(frame$pos, jsonlite::fromJSON)
  get_coord <- function(n) {
    map(pos, function(x) x[[n]]) %>%
      unlist()
  }
  frame$pos_x <- get_coord(1)
  frame$pos_y <- get_coord(2)
  frame
}

recode_team <- function(frame) {
  teams <- unique(frame$team) %>%
    map(function(team) {
      data <- jsonlite::fromJSON(team)
      data$players %>%
        mutate(
          player = 1:n(),
          team_id = data$name,
          team = team
        )
    }) %>%
    bind_rows()

  # Order teams from most disjoint to least
  team_levels <- letters[5:1]
  team_map <- teams %>%
    select(team, team_id) %>%
    unique() %>%
    arrange(team_id) %>%
    mutate(team_label = factor(team_id, levels = team_levels))
  
  left_join(frame, team_map)
}
```

```{r theme, include=FALSE}
library(RColorBrewer)
base_theme <- theme_minimal()

theme_colors <- brewer.pal(4, "Set2")
names(theme_colors) <- c("blue", "orange", "green", "pink")
get_theme_color_values <- function(names) theme_colors[names] %>% unname()

scale_color_strategy <- scale_color_manual(
  "strategy",
  values = get_theme_color_values(c("green", "blue"))
)

scale_color_team_label <- scale_color_manual(
  "skill overlap",
  labels = c("4 disjoint", "3", "2 overlapping", "1", "0 identical"),
  values = brewer.pal(7, "BuGn")[7:3]
)
```

```{r team-structures, engine="dot", fig.width=2}
```

# Identical team

```{r}
identical_team <- get_experiment_data("identical-team")

ggplot(identical_team) +
  aes(time, fitness_pct, color = strategy) +
  geom_line(stat = "summary", fun.y = "mean") +
  scale_x_continuous("calendar hours") +
  scale_y_continuous("fitness", labels = scales::percent) +
  scale_color_strategy +
  base_theme
```

```{r}
identical_team %<>%
  extract_position() %>%
  mutate(sim_id = paste(strategy, seed, sep = ":"))

sample_sim_ids <- identical_team %>%
  group_by(strategy) %>%
  sample_n(5) %>%
  .$sim_id

ggplot(identical_team %>% filter(sim_id %in% sample_sim_ids)) +
  aes(pos_x, pos_y, group = sim_id, color = strategy) +
  geom_point(size = 0.5) +
  geom_line() +
  coord_equal() +
  facet_wrap("strategy") +
  scale_color_strategy +
  base_theme +
  theme(legend.position = "none")
```

# Differing skills

```{r}
differing_skills <- get_experiment_data("differing-skills") %>%
  recode_team()

ggplot(differing_skills) +
  aes(time, fitness_pct, color = team_label, lty = strategy) +
  geom_line(stat = "summary", fun.y = "mean") +
  scale_x_continuous("calendar hours") +
  scale_y_continuous("fitness", labels = scales::percent) +
  scale_linetype_manual(values = c("solid", "longdash")) +
  scale_color_team_label +
  guides(lty = guide_legend(order = 1),
         color = guide_legend(order = 2)) +
  base_theme
```

# Rate of alternation

```{r}
alternating <- get_experiment_data("alternating")

ggplot(alternating) +
  aes(time, fitness_pct, color = strategy) +
  geom_line(stat = "summary", fun.y = "mean") +
  scale_x_continuous("calendar hours") +
  scale_y_continuous("fitness", labels = scales::percent) +
  scale_color_strategy +
  base_theme
```

# Aggregate functions

```{r}
aggregate_fns <- get_experiment_data("aggregate-functions") 

ggplot(aggregate_fns) +
  aes(time, fitness_pct, color = aggregate_fn) +
  geom_line(stat = "summary", fun.y = "mean") +
  scale_color_brewer(palette = "Set2") +
  base_theme
```